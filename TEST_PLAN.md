# BME680気象観測システム 検証計画

## 概要

堅牢化版v2.0の検証項目リスト。長時間稼働、各種障害シナリオでの動作確認を実施します。

## 検証環境

- ハードウェア: Raspberry Pi Pico W + BME680センサー
- ファームウェア: MicroPython
- バージョン: 堅牢化版 v2.0

## 検証項目

### 1. 正常動作の確認

#### 1.1 基本動作
- [ ] 起動時セルフチェックが正常に完了すること
- [ ] BME680センサーからデータが正常に読み取れること
- [ ] WiFiに正常に接続できること
- [ ] Ambientへのデータ送信が成功すること
- [ ] 30秒間隔でセンサーデータが表示されること
- [ ] 10分間隔でAmbientにデータが送信されること

#### 1.2 メモリ管理
- [ ] 初回起動時のメモリ使用量を記録
- [ ] 10ループごとのメモリ情報表示を確認
- [ ] メモリリークがないこと（長時間稼働でメモリが増え続けないこと）

#### 1.3 WDT動作
- [ ] WDTが正常に初期化されること
- [ ] メインループでWDT feedが実行されていること
- [ ] WDTタイムアウト値が300秒に設定されていること

---

### 2. 長時間稼働テスト

#### 2.1 24時間連続稼働
**目的**: システムが24時間以上安定して動作することを確認

**手順**:
1. システムを起動
2. 24時間以上稼働させる
3. メモリ使用量の推移を記録
4. センサーデータの取得状況を確認
5. Ambient送信の成功率を確認

**期待結果**:
- [ ] システムが停止せずに24時間以上稼働すること
- [ ] メモリリークがないこと
- [ ] センサーデータ取得の成功率が95%以上
- [ ] Ambient送信の成功率が95%以上

**記録項目**:
- 稼働時間:
- メモリ使用量（開始時）:
- メモリ使用量（終了時）:
- センサーデータ取得成功回数:
- センサーデータ取得失敗回数:
- Ambient送信成功回数:
- Ambient送信失敗回数:

#### 2.2 1週間連続稼働
**目的**: 長期運用時の安定性を確認

**手順**:
1. システムを起動
2. 1週間稼働させる
3. 定期的にログを確認

**期待結果**:
- [ ] システムが1週間以上稼働すること
- [ ] メモリリークがないこと
- [ ] エラーが発生しても自動復旧すること

---

### 3. WiFi障害テスト

#### 3.1 WiFi一時切断
**目的**: WiFi接続が一時的に切断された場合の自動復旧を確認

**手順**:
1. システムを正常に起動
2. WiFiルーターを30秒間オフにする
3. WiFiルーターをオンに戻す
4. 自動再接続を確認

**期待結果**:
- [ ] WiFi切断が検出されること
- [ ] 指数バックオフで再接続が試行されること
- [ ] WiFi復旧後、自動的に再接続すること
- [ ] データ送信が再開されること

**記録項目**:
- 切断検出までの時間:
- 再接続までの時間:
- 再接続試行回数:

#### 3.2 WiFi長時間切断
**目的**: WiFiが長時間切断された場合の動作を確認

**手順**:
1. システムを正常に起動
2. WiFiルーターを10分間オフにする
3. WiFiルーターをオンに戻す
4. 自動再接続を確認

**期待結果**:
- [ ] WiFi未接続でもセンサーデータ取得は継続すること
- [ ] WiFi復旧後、自動的に再接続すること
- [ ] システムがハングアップしないこと

#### 3.3 SSID切り替え
**目的**: 複数SSIDに対応した接続を確認

**手順**:
1. WIFI_NETWORKSに複数のSSIDを設定
2. 優先度1のSSIDをオフにする
3. システムが優先度2のSSIDに接続することを確認

**期待結果**:
- [ ] 優先度順にSSIDが試行されること
- [ ] 利用可能なSSIDに接続できること

---

### 4. I2C/センサー障害テスト

#### 4.1 センサー読み取りエラー
**目的**: I2C通信エラー時の再試行動作を確認

**手順**:
1. システムを正常に起動
2. センサーの配線を一時的に緩める（I2C通信エラーを誘発）
3. エラー検出と再試行を確認
4. 配線を元に戻す

**期待結果**:
- [ ] I2C読み取りエラーが検出されること
- [ ] 最大3回まで再試行すること
- [ ] エラーログが出力されること
- [ ] 配線復旧後、正常動作に戻ること

#### 4.2 センサー連続失敗
**目的**: センサー読み取りが連続して失敗した場合のI2C再初期化を確認

**手順**:
1. システムを正常に起動
2. センサーの配線を5分以上外す
3. I2C再初期化が実行されることを確認
4. 配線を元に戻す

**期待結果**:
- [ ] 連続失敗回数がカウントされること
- [ ] 5回連続失敗でI2C再初期化が実行されること
- [ ] 再初期化成功後、正常動作に戻ること
- [ ] 再初期化失敗時、WDTによるリセットが実行されること

---

### 5. HTTP送信障害テスト

#### 5.1 Ambient送信エラー
**目的**: Ambient送信失敗時の再試行動作を確認

**手順**:
1. システムを正常に起動
2. ファイアウォールでAmbientへの通信を一時的にブロック
3. 再試行動作を確認
4. 通信を復旧

**期待結果**:
- [ ] 送信エラーが検出されること
- [ ] 最大3回まで再試行すること
- [ ] ソケットが確実にクローズされること
- [ ] 通信復旧後、正常に送信されること

#### 5.2 長時間送信失敗
**目的**: 送信が長時間失敗し続けた場合の動作を確認

**手順**:
1. システムを正常に起動
2. Ambientへの通信を30分間ブロック
3. システムが安定動作を継続することを確認

**期待結果**:
- [ ] 送信失敗でもセンサーデータ取得は継続すること
- [ ] システムがハングアップしないこと
- [ ] メモリリークがないこと

---

### 6. 電源障害テスト

#### 6.1 電源瞬断（ソフトリセット）
**目的**: 電源瞬断後の自動復旧を確認

**手順**:
1. システムを正常に起動
2. Pico WのRESETボタンを押す
3. システムが自動的に再起動することを確認

**期待結果**:
- [ ] システムが正常に再起動すること
- [ ] セルフチェックが実行されること
- [ ] 全機能が正常動作すること

#### 6.2 電源瞬断（ハードリセット）
**目的**: 電源完全断後の復旧を確認

**手順**:
1. システムを正常に起動
2. USB電源を抜く
3. 10秒後にUSB電源を挿す
4. システムが自動的に起動することを確認

**期待結果**:
- [ ] システムが正常に起動すること
- [ ] 設定が保持されていること
- [ ] 全機能が正常動作すること

#### 6.3 低電圧動作
**目的**: 電源電圧が低下した場合の動作を確認

**手順**:
1. 電源電圧を監視しながらシステムを起動
2. 動作中の電圧変動を確認

**期待結果**:
- [ ] 電圧が安定していること
- [ ] 電圧低下時もシステムが安定動作すること

---

### 7. WDTタイムアウトテスト

#### 7.1 意図的なハング
**目的**: WDTが正常に動作し、ハング時にリセットされることを確認

**手順**:
1. コードを一時的に修正して無限ループを挿入
2. WDTタイムアウト（5分）を待つ
3. システムがリセットされることを確認

**期待結果**:
- [ ] 5分後にWDTタイムアウトが発生すること
- [ ] システムが自動的にリセットされること
- [ ] 再起動後、正常動作すること

**注意**: このテストは検証用のため、実際の運用コードでは実施しない

---

### 8. メモリストレステスト

#### 8.1 メモリ使用量監視
**目的**: メモリリークがないことを確認

**手順**:
1. システムを起動
2. 1時間ごとにメモリ使用量を記録
3. 24時間分のデータを取得

**期待結果**:
- [ ] メモリ使用量が安定していること
- [ ] メモリリークがないこと
- [ ] gc.collect()が効果的に動作していること

**記録シート**:
| 経過時間 | メモリ使用量 | 空きメモリ | 使用率 |
|---------|------------|----------|--------|
| 0h      |            |          |        |
| 1h      |            |          |        |
| 2h      |            |          |        |
| 3h      |            |          |        |
| 6h      |            |          |        |
| 12h     |            |          |        |
| 18h     |            |          |        |
| 24h     |            |          |        |

---

## 総合評価基準

### 合格基準
- すべてのテスト項目で期待結果を満たすこと
- 24時間連続稼働テストで成功率95%以上
- 致命的エラー（リカバリ不可能な停止）が発生しないこと
- メモリリークがないこと

### 不合格の場合
- 該当する問題を修正
- 再度検証を実施

---

## 検証記録

### 実施日
- 開始日時:
- 終了日時:
- 担当者:

### 検証結果サマリー
- 総テスト項目数:
- 合格項目数:
- 不合格項目数:
- 保留項目数:

### 総合評価
- [ ] 合格
- [ ] 不合格
- [ ] 保留

### 備考

---

## 改善提案

検証中に発見した問題点や改善提案を記載:

1.
2.
3.

---

## 次回検証予定

- 日時:
- 内容:
